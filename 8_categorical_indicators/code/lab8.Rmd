---
title: "Lab 8: Categorical Indicators" 
subtitle: "Introduction to SEM with lavaan"
author: "Kyle M. Lang"
date: "Updated: `r format(Sys.time(), format = '%Y-%m-%d')`"
params:
  answers: true
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 1
    toc_float: true
    number_sections: true
    df_print: paged
    css: "../../resources/style.css"
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(knitr)
library(dplyr)
library(magrittr)

figDir <- "../figures/"

set.seed(235711)

## Define an asis engine that will evaluate inline code within an asis block:
knit_engines$set(asis = function(options) {
  if(options$echo && options$eval) knit_child(text = options$code)
}
)

opts_chunk$set(include = params$answers, 
               echo = params$answer, 
               message = FALSE,
               warning = FALSE,
               fig.align = "center",
               comment = NA)
```

<!-- 
Define some hacky LaTeX commands to force nice spacing between lines    
NOTE: These must be called within a math environment (e.g., $\va$)
-->
\newcommand{\va}{\\[12pt]}
\newcommand{\vb}{\\[6pt]}
\newcommand{\vc}{\\[3pt]}
\newcommand{\vx}[1]{\\[#1pt]}

---

In this lab, you will practice methods doing CFA/SEM with categorical data using 
**lavaan**.

---

# Data

---

```{r, include = FALSE}
dataDir <- "../../data/"
outlook <- readRDS(paste0(dataDir, "outlook.rds"))
head(outlook)
```

We will first revisit the synthetic [*Outlook on Life Survey*][outlook0] data 
from Lab 5. Recall that the original data were collected in the United States in 
2012 to measure, among other things, attitudes about racial issues, opinions of 
the Federal government, and beliefs about the future.

We will agian work with a synthesized subset of the original data. You can access
these synthetic data as [*outlook.rds*][outlook1]. This dataset comprises 
`r nrow(outlook)` observations of the following `r ncol(outlook)` variables.

- `d1:d3`: Three observed indicators of a construct measuring disillusionment 
with the US Federal government.
   - Higher scores indicate more disillusionment
   $\vb$
- `s1:s4`: Four observed indicators of a construct measuring the perceived 
achievability of material success.
   - Higher scores indicate greater perceived achievability
   $\vb$
- `progress`: A single item assessing perceived progress toward achieving the 
"American Dream"
   - Higher scores indicate greater perceived progress
   $\vb$
- `merit`: A single item assessing endorsement of the meritocratic ideal that 
hard work leads to success.
   - Higher scores indicate stronger endorsement of the meritocratic ideal
   $\vb$
- `lib2Con`: A single item assessing liberal-to-conservative orientation
   - Lower scores are more liberal, higher scores are more conservative
   $\vb$
- `party`: A four-level factor indicating self-reported political party affiliation
   $\vb$
- `disillusion`: A scale score representing disillusionment with the US Federal 
government
   - Created as the mean of `d1:d3`
   $\vb$
- `success`: A scale score representing the perceived achievability of material 
success
   - Created as the mean of `s1:s4`

---

###

**Read in the *outlook.rds* dataset.**

```{r, eval = FALSE}
dataDir <- "../data/"
outlook <- readRDS(paste0(dataDir, "outlook.rds"))
```

NOTE: In the following, I will refer to these data as the *outlook data*.

---

For the following, we don't need/want the scale scores for *disillusionment* or
*success* or the observations for which `party = "other"`. Run the following
code to exclude these parts of the dataset.

```{r subset}
library(dplyr)
library(magrittr)

outlook %<>% subset(-disillusion, -success) %>% filter(party = "other")
```

---

###

**Summarize the distributions of the *disillusion* and *success* items.**

What do you notice about the measurement level of these items?

```{r}
outlook %T>% summary(outlook)

```



```{r, include = FALSE}
dataDir <- "../data/"
ea <- readRDS(paste0(dataDir, "eating_attitudes_completed.rds"))
```

We will move on to a different dataset to explore serial mediator models. 
Specifically, we will work with a slightly modified version of the *Eating 
Attitudes* data used for some example analyses in [Enders (2010)][amda]. These 
data are available as [*eating_attitudes_completed.rds*][ea_data1].

This dataset includes `r nrow(ea)` observations of the following `r ncol(ea)` 
variables. Note that the variables are listed in the order that they appear on 
the dataset.

- `id`: A numeric ID
- `eat1:eat24`: Seven indicators of a *Drive for Thinness* construct
- `eat3:eat21`: Three indicators of a *Preoccupation with Food* construct
- `bmi`: Body mass index
- `wsb`: A single item assessing *Western Standards of Beauty*
- `anx`: A single item assessing *Anxiety Level*

You can download the original data [here][ea_data0], and you can access the code 
used to process the data [here][ea_code].

---

##

**Read in the *eating_attitudes_completed.rds* dataset.**

```{r, eval = FALSE}
dataDir <- "../data/"
ea <- readRDS(paste0(dataDir, "eating_attitudes_completed.rds"))
```

NOTE: In the following, I will refer to these data as the *EA data*.

---

##

**Summarize the EA data to get a sense of their characteristics.**

```{r}
head(ea)
summary(ea)
str(ea)
```

---

# Serial Multiple Mediation

---

We will evaluate a serial multiple mediation model wherein the effect of 
*Western Standards of Beauty* on *Preoccupation with Food* is mediated by the 
sequential intermediaries *Drive for Thinness* and *Anxiety*. The causal process 
represented by our model would suggest that Western beauty standards induce a 
drive for thinness which, in turn, causes anxiety which, finally, leads to a 
preoccupation with food.

---

##

**Draw a path diagram for the model described above.**

- Label the relevant structural paths.

```{r, echo = FALSE, out.width = "85%"}
knitr::include_graphics(paste0(figDir, "lab4_serial_mediation.png"))
```

---

##

**Write out the structural equations necessary to evaluate the mediation 
hypothesis described above.**

```{asis}
\[
\begin{align}
\eta_{pre} &= b_1 \eta_{drive} + b_2 X_{anx} + c' X_{wsb} + \varepsilon_3\\
X_{anx} &= a_2 X_{wsb} + d \eta_{drive} + \varepsilon_2\\
\eta_{drive} &= a_1 X_{wsb} + \varepsilon_1
\end{align}
\]
```


---

##

**Define the model syntax for the CFA.**

The data only contain multi-item scales for *Drive for Thinness* and 
*Preoccupation with Food*, so we only need a two-dimensional CFA evaluating the 
measurement structure of these two factors.

- Indicated the *Drive for Thinness* factor from the seven relevant scale items.
   - `eat1`, `eat2`, `eat10`, `eat11`, `eat12`, `eat14`, `eat24`
- Indicated the *Preoccupation with Food* factor from the remaining three scale 
items.
   - `eat3`, `eat18`, `eat21`
   
```{r}
cfaMod4 <- '
drive =~ eat1 + eat2  + eat10 + eat11 + eat12 + eat14 + eat24
pre   =~ eat3 + eat18 + eat21
'
```

---

##

**Estimate the CFA model on the EA data.**

- Correlate the latent factors.
- Set the scale by standardizing the latent factors.
- Do not include any mean structure.

```{r}
cfaFit4 <- cfa(cfaMod4, data = ea, std.lv = TRUE)
```

---

## 

**Summarize the fitted CFA and check the model fit.**

- Do the parameter estimates look sensible?
- Does the model fit the data well enough?

```{r}
summary(cfaFit4)
fitMeasures(cfaFit4)
```

```{asis}
This model looks good. All measurement model parameters seem reasonable, and the 
model fits the data well.
```

---

##

**Define the model syntax for the structural model.**

- Specify all paths needed to test the multiple mediation hypothesis described 
above.
- Include defined parameters to quantify all specific indirect effects and the 
total indirect effect.

```{r}
## Define only the new structural parts:
semMod4 <- '
pre   ~ b1 * drive + b2 * anx + cp * wsb
anx   ~ d * drive  + a2 * wsb
drive ~ a1 * wsb

ab1 := a1 * b1
ab2 := a2 * a2
adb := a1 * d * b2
ie  := ab1 + ab2 + adb
'

## Add on the measurement part:
semMod4 <- paste(cfaMod4, semMod4, sep = '\n')
```

---

##

**Estimate the structural model.**

- Use B = 2000 bootstrap resamples to quantify the sampling variability.

```{r serial_mediation_boot, cache = TRUE}
semFit4 <- sem(semMod4, data = ea, std.lv = TRUE, se = "boot", bootstrap = 2000)
summary(semFit4)
```

---

##

**Interpret the results.**

a. Is the two-step specific indirect effect through *Drive for Thinness* 
significant according to the 95% BC CI?
a. Is the two-step specific indirect effect through *Anxiety* significant 
according to the 95% BC CI?
a. Is the full, three-step specific indirect effect through *Drive for Thinness* 
and *Anxiety* significant according to the 95% BC CI?
a. Is the total indirect effect significant according to the 95% BC CI?
a. Briefly interpret the indirect effects.

```{r}
parameterEstimates(semFit4, boot.ci.type = "bca.simple") %>% 
  select(-(1:3)) %>%
  tail(4)
```

```{r, include = FALSE}
tmp <- parameterEstimates(semFit4, boot.ci.type = "bca.simple") %>% tail(4)
out1 <- tmp[1, ]
out2 <- tmp[2, ]
out3 <- tmp[3, ]
out4 <- tmp[4, ]
```

```{asis}
a. Yes, the two-step specific indirect effect through *Drive for Thinness* is 
statistically significant (
$ab = `r round(out1$est, 3)`$, 
$95\%~CI_{BC} = [`r round(out1$ci.lower, 3)`; `r round(out1$ci.upper, 3)`]$
).

a. No, the two-step specific indirect effect through *anxiety* is not 
statistically significant (
$ab = `r round(out2$est, 3)`$, 
$95\%~CI_{BC} = [`r round(out2$ci.lower, 3)`; `r round(out2$ci.upper, 3)`]$
).

   - The lower bound of the CI rounds down to zero. Although one could conclude 
   a just barely significant effect from the CI alone, the small point estimate 
   and the large p-value for the bootstrapped z-test both suggest against 
   inferring a significant effect. 
$\va$
a. Yes, the full, three-step specific indirect effect is statistically 
significant (
$adb = `r round(out3$est, 3)`$, 
$95\%~CI_{BC} = [`r round(out3$ci.lower, 3)`; `r round(out3$ci.upper, 3)`]$
).

a. Yes, the total indirect effect is statistically significant (
$IE = `r round(out4$est, 3)`$, 
$95\%~CI_{BC} = [`r round(out4$ci.lower, 3)`; `r round(out4$ci.upper, 3)`]$
).

a. The hypothesized causal chain linking Western beauty standards to 
preoccupation with food through drive for thinness and anxiety was supported by 
a statistically significant specific indirect effect. Western beauty 
standards had a significant, positive effect on preoccupation with food, and 
this effect was transmitted indirectly by first increasing the drive for thinness 
which subsequently increased anxiety to, finally, increase preoccupation with 
food.

   A subprocess by which the effect of Western beauty standards on preoccupation 
   with food is transmitted indirectly through drive for thinness was also 
   supported by a statistically significant, positive indirect effect. The 
   analogous subprocess transmitted through anxiety levels was associated with a 
   nonsignificant indirect effect and, hence, was not supported by these results.
```

---

End of Lab 4

---

[hs_data]: https://github.com/kylelang/lavaan-e-learning/raw/main/4_sem_mediation/data/holzinger_swineford.rds
[mbess]: https://cran.r-project.org/web/packages/MBESS/index.html
[hs_code]: https://github.com/kylelang/lavaan-e-learning/blob/main/code/lab_prep/process_hs_data.R
[amda]: https://www.cms.guilford.com/books/Applied-Missing-Data-Analysis/Craig-Enders/9781606236390
[ea_data0]: https://www.appliedmissingdata.com/analyses
[ea_data1]: https://github.com/kylelang/lavaan-e-learning/raw/main/4_sem_mediation/data/eating_attitudes_completed.rds
[ea_code]: https://github.com/kylelang/lavaan-e-learning/blob/main/code/lab_prep/process_eating_data.R
