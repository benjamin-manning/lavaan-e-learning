### Title:    Mediation & Moderation: Lecture 5 Examples
### Author:   Kyle M. Lang
### Created:  2016-FEB-06
### Modified: 2016-FEB-29

library(lavaan)

dataDir <- "../data/"

dat1 <- readRDS(paste0(dataDir, "adamsKlpsData.rds"))

mod1.1 <- "
merit =~ meritP1 + meritP2 + meritP3
policy =~ policyP1 + policyP2 + policyP3
"

out1.1 <- cfa(mod1.1, data = dat1, std.lv = TRUE)
fitMeasures(out1.1)
summary(out1.1)


mod1.2 <- "
merit =~ meritP1 + meritP2 + meritP3
policy =~ policyP1 + policyP2 + policyP3

policy ~ b*merit + polAffil
merit ~ a*polAffil

ab := a*b
"

out1.2 <- sem(mod1.2, data = dat1, std.lv = TRUE, se = "boot", boot = 500)
summary(out1.2)
parameterEstimates(out1.2, boot.ci.type = "bca.simple")


mod2 <- "
policy ~ b*sysRac + cp*polAffil
sysRac ~ a*polAffil

ab := a*b
"

## Estimate the model:
out2 <- sem(mod2, data = dat1)
summary(out2)

## Extract the necessary estimates:
ab <- prod(coef(out2)[c("a", "b")])
cPrime <- coef(out2)["cp"]

sdY <- sd(dat1$policy)
sdX <- sd(dat1$polAffil)

r2MY <- with(dat1, cor(policy, sysRac))
r2XY <- with(dat1, cor(policy, polAffil))
R2Y.MX <- inspect(out2, "r2")["policy"]

### Compute the various effect sizes:

## Paritally Standardized:
abPS <- ab / sdY
cPrimePS <- cPrime / sdY
cPS <- abPS + cPS

## Completely Standardized:
abCS <- (sdX * ab) / sdY
cPrimeCS <- (sdX * cPrime) / sdY
cCS <- abCS + cPrimeCS

## Proportions:
pm <- ab / (cPrime + ab)
rm <- ab / cPrime

## R2:
R2med <- r2MY - (R2Y.MX - r2XY)


tmpData <- dat1[ , c("polAffil", "sysRac", "policy")]
colnames(tmpData) <- c("x", "m", "y")

cov1 <- cov(tmpData)

sYM <- cov1["x", "m"]
sYX <- cov1["y", "x"]
sMX <- cov1["m", "x"]
s2X <- cov1["x", "x"]
s2M <- cov1["m", "m"]
s2Y <- cov1["y", "y"]

aMarg <- sqrt(s2M * s2Y - sYM^2) * sqrt(s2X * s2Y - sYX^2)
aInt <- c(
    (sYM * sYX - aMarg) / (s2X * s2Y),
    (sYM * sYX + aMarg) / (s2X * s2Y)
)

bMarg <- sqrt(s2X * s2Y - sYX^2) / sqrt(s2X * s2M - sMX^2)
bInt <- c(-1 * bMarg, bMarg)

aMax <- ifelse(coef(out2)["a"] < 0,
               aInt[1],
               aInt[2])

bMax <- ifelse(coef(out2)["b"] < 0,
               bInt[1],
               bInt[2])

abMax <- aMax * bMax

k2 <- ab / abMax
