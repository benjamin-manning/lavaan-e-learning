### Title:    Med/Mod Lecture 9: Examples
### Author:   Kyle M. Lang
### Created:  2016-MAR-17
### Modified: 2016-JUN-06

rm(list = ls(all = TRUE))

dataDir <- "../data/"

library(psych)
library(rockchalk)
library(lavaan)
library(semTools)
library(mice)

## Data wrangling:
data(bfi)
dat1 <- data.frame(
    agree  = rowMeans(bfi[ , grep("^A", colnames(bfi))]),
    conc   = rowMeans(bfi[ , grep("^C", colnames(bfi))]),
    extra  = rowMeans(bfi[ , grep("^E", colnames(bfi))]),
    neuro   = rowMeans(bfi[ , grep("^N", colnames(bfi))]),
    open   = rowMeans(bfi[ , grep("^O", colnames(bfi))]),
    gender = bfi$gender
)

dat1$gender <- as.factor(dat1$gender)

educ <- rep(1, nrow(bfi))
educ[bfi$education >= 2] <- 2
educ[bfi$education >= 4] <- 3
educ[is.na(bfi$education)] <- NA

dat1$educ <- as.factor(educ)
levels(dat1$educ) <- c("subHS", "highSchool", "college")

bfi2 <- bfi[ , setdiff(colnames(bfi), "education")]
bfi2$educ <- dat1$educ

miceOut1 <- mice(dat1, m = 1, maxit = 100)
dat2 <- complete(miceOut1, 1)

miceOut2 <- mice(bfi2, m = 1, maxit = 100)
bfi2 <- complete(miceOut2, 1)

dat2 <- dat2[bfi$age >= 18, ]
bfi2 <- bfi2[bfi$age >= 18, ]

saveRDS(dat2,
        file = paste0(dataDir, "bfiData1.rds")
        )
saveRDS(bfi2,
        file = paste0(dataDir, "bfiData2.rds")
        )

out1.1 <- lm(agree ~ conc + open + neuro, data = dat2)
summary(out1.1)

out1.2 <- lm(agree ~ open*conc + open*neuro, data = dat2)
summary(out1.2)

dat2$concLo  <- with(dat2, conc - quantile(conc, 0.25, na.rm = TRUE))
dat2$concMid <- with(dat2, conc - quantile(conc, 0.5, na.rm = TRUE))
dat2$concHi  <- with(dat2, conc - quantile(conc, 0.75, na.rm = TRUE))

out1.2.1 <- lm(agree ~ open*concLo + neuro, data = dat2)
summary(out1.2.1)

out1.2.2 <- lm(agree ~ open*concMid + neuro, data = dat2)
summary(out1.2.2)

out1.2.3 <- lm(agree ~ open*concHi + neuro, data = dat2)
summary(out1.2.3)

plotSlopes(model = out1.2,
           plotx = "open",
           modx = "conc",
           plotPoints = FALSE,
           modxVals =
               quantile(dat2$conc,
                        c(0.25, 0.5, 0.75),
                        na.rm = TRUE)
           )

out1.3 <- lm(agree ~ open*conc*neuro, data = dat2)
summary(out1.3)

dat2$neuroLo <-
    with(dat2,
         neuro - (mean(neuro, na.rm = TRUE) - sd(neuro, na.rm = TRUE))
         )
dat2$neuroMid <- with(dat2, neuro - mean(neuro, na.rm = TRUE))
dat2$neuroHi <-
    with(dat2,
         neuro - (mean(neuro, na.rm = TRUE) + sd(neuro, na.rm = TRUE))
         )

out1.4.1 <- lm(agree ~ open*conc*neuroLo, data = dat2)
summary(out1.4.1)

out1.4.2 <- lm(agree ~ open*conc*neuroMid, data = dat2)
summary(out1.4.2)

out1.4.3 <- lm(agree ~ open*conc*neuroHi, data = dat2)
summary(out1.4.3)

dat2$openXneuro <- with(dat2, neuro*open)
dat2$concXneuro <- with(dat2, neuro*conc)
dat2$openXconc <- with(dat2, open*conc)
dat2$openXconcXneuro <- with(dat2, open*conc*neuro)

out1.5 <- lm(agree ~ open + conc + neuro +
                 openXconc + openXneuro + concXneuro + openXconc*neuro,
             data = dat2)
summary(out1.5)

coef(out1.3) - coef(out1.5)

plotOut1.5 <- plotSlopes(model = out1.5,
                         plotx = "openXconc",
                         modx = "neuro",
                         plotPoints = FALSE)
testOut1.5 <- testSlopes(plotOut1.5)
plot(testOut1.5)

## Categorical moderator:
out2.1 <- lm(conc ~ neuro, data = dat2)
summary(out2.1)

out2.2 <- lm(conc ~ neuro*educ, data = dat2)
summary(out2.2)

plotSlopes(out2.2,
           plotx = "neuro",
           modx = "educ",
           plotPoints = FALSE)

ssSubHS <- coef(out2.2)[2]
ssHighSchool <- sum(coef(out2.2)[c(2, 5)])
ssCollege <- sum(coef(out2.2)[c(2, 6)])

ssSubHS
ssHighSchool
ssCollege

dat2$educ2 <- relevel(dat2$educ, ref = "highSchool")
dat2$educ3 <- relevel(dat2$educ, ref = "college")

out2.3 <- lm(conc ~ neuro*educ2, data = dat2)
summary(out2.3)

out2.4 <- lm(conc ~ neuro*educ3, data = dat2)
summary(out2.4)


## Multiple group moderation:
mod1 <- "
conc =~ C1 + C2 + C3 + C4 + C5
neuro =~ N1 + N2 + N3 + N4 + N5
"

fit1 <- measurementInvariance(mod1,
                              data = bfi2,
                              group = "educ",
                              std.lv = TRUE)

mod2 <- "
conc =~ C1 + C2 + C3 + C4 + C5
neuro =~ N1 + N2 + N3 + N4 + N5

conc ~ neuro

conc ~~ c(1.0, NA, NA)*conc
neuro ~~ c(1.0, NA, NA)*neuro

conc ~ c(0.0, NA, NA)*1.0
neuro ~ c(0.0, NA, NA)*1.0
"

fit2 <- lavaan(mod2,
               data = bfi2,
               std.lv = FALSE,
               auto.fix.first = FALSE,
               auto.var = TRUE,
               int.ov.free = TRUE,
               group = "educ",
               group.equal = c("loadings", "intercepts")
               )
summary(fit2)


mod3 <- "
conc =~ C1 + C2 + C3 + C4 + C5
neuro =~ N1 + N2 + N3 + N4 + N5

conc ~ c(b1, b1, b1)*neuro

conc ~~ c(1.0, NA, NA)*conc
neuro ~~ c(1.0, NA, NA)*neuro

conc ~ c(0.0, NA, NA)*1.0
neuro ~ c(0.0, NA, NA)*1.0
"

fit3 <- lavaan(mod3,
               data = bfi2,
               std.lv = FALSE,
               auto.fix.first = FALSE,
               auto.var = TRUE,
               int.ov.free = TRUE,
               group = "educ",
               group.equal = c("loadings", "intercepts")
               )
summary(fit3)

diffVec <- fitMeasures(fit3)[c("chisq", "df")] -
    fitMeasures(fit2)[c("chisq", "df")]

pchisq(diffVec[1], diffVec[2], lower = FALSE)


mod4 <- "
conc =~ C1 + C2 + C3 + C4 + C5
neuro =~ N1 + N2 + N3 + N4 + N5

conc ~ c(b1, b1, b2)*neuro

conc ~~ c(1.0, NA, NA)*conc
neuro ~~ c(1.0, NA, NA)*neuro

conc ~ c(0.0, NA, NA)*1.0
neuro ~ c(0.0, NA, NA)*1.0
"

fit4 <- lavaan(mod4,
               data = bfi2,
               std.lv = FALSE,
               auto.fix.first = FALSE,
               auto.var = TRUE,
               int.ov.free = TRUE,
               group = "educ",
               group.equal = c("loadings", "intercepts")
               )
summary(fit4)

diffVec <- fitMeasures(fit4)[c("chisq", "df")] -
    fitMeasures(fit2)[c("chisq", "df")]

pchisq(diffVec[1], diffVec[2], lower = FALSE)

tmp <- inspect(fit2, "est")

ints <- c(0,
          coef(fit2)[c("conc~1.g2",
                       "conc~1.g3")]
          )
slopes <- coef(fit2)[c("conc~neuro",
                       "conc~neuro.g2",
                       "conc~neuro.g3")]

fScores <- do.call(rbind, predict(fit2))
plot(y = fScores[ , "conc"],
     x = fScores[ , "neuro"],
     type = "n",
     main = "Simple Slopes",
     xlab = "Neuroticism",
     ylab = "Conscientiousness")

abline(a = ints[1], b = slopes[1])
abline(a = ints[2], b = slopes[2], col = "red")
abline(a = ints[3], b = slopes[3], col = "blue")

legend(x = "topright",
       inset = 0.01,
       legend =
           c("< High School",
             "High School",
             "College"),
       col =
           c("black",
             "red",
             "blue"),
       lty = 1)

       
?abline
