\documentclass{beamer}
\usetheme{ttuStatsCamp}
\usefonttheme{serif}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
%\usepackage{mathptmx}
\usepackage{url}
\usepackage{graphicx}
\usepackage{setspace}
%\usepackage{esint}
\usepackage[natbibapa]{apacite}
\usepackage{color}
\usepackage{amsmath}
\usepackage{amsfonts}
%\usepackage{bm}
\usepackage{Sweavel}
\usepackage{listings}

\def\Sweavesize{\scriptsize}
\def\Rcolor{\color{black}}
%\def\Routcolor{\color{red}}
\def\Rcommentcolor{\color{violet}}
\def\Rbackground{\color[gray]{0.85}}
\def\Routbackground{\color[gray]{0.85}}

\lstset{tabsize=2, breaklines=true, style=Rstyle}

\SweaveOpts{keep.source=T, prefix.string=sweaveFiles/, split=T, ae=F, height=4, width=6}

\newcommand{\red}[0]{\textcolor{red}}
%\newcommand{\violet}[0]{\textcolor{violet}}
\newcommand{\green}[0]{\textcolor{green}}
\newcommand{\blue}[0]{\textcolor{blue}}
\newcommand{\comment}[1]{}
\newcommand{\kfold}[0]{\emph{K}-fold cross-validation}
\newcommand{\va}[0]{\vspace{12pt}}
\newcommand{\vb}[0]{\vspace{6pt}}
\newcommand{\vc}[0]{\vspace{3pt}}
\newcommand{\vx}[1]{\vspace{#1pt}}

\title[Lecture 3]{Lecture 3: Less-Simple Mediation Analysis}

\author{Kyle M. Lang}

\institute[TTU IMMAP]{
  Institute for Measurement, Methodology, Analysis \& Policy\\
  Texas Tech University\\
  Lubbock, TX
}

\date{2016 Stats Camp}

\setbeamertemplate{frametitle continuation}{}

\begin{document}

\setkeys{Gin}{width=\textwidth}

<<echo=F>>=
options(width=160, prompt=" ", continue=" ", useFancyQuotes = TRUE)
library(xtable)
library(mvtnorm)
library(mice)
@


\begin{frame}[plain]

  \titlepage
  
\end{frame}



\begin{frame}{Outline}

  \begin{itemize}
  \item Show how to estimate indirect effects with path diagrams
    \vspace{12pt}
  \item Discuss the use of \emph{bootstrapping} for testing indirect
    effects
    \vspace{12pt}
  \item Discuss the Monte Carlo simulation method for testing indirect
    effects
  \end{itemize}

\end{frame}



\begin{frame}{Recall our Basic Path Diagram}

\begin{figure}
\includegraphics[width=\textwidth]{figures/simpleMediationPathDiagram.pdf}
\end{figure}

\end{frame}


\begin{frame}{The Basic OLS Equations}

  To get all the pieces of the preceding diagram using OLS regression,
  we're forced fit three equations.

\begin{align}
Y &= i_1 + cX + e_1 \label{eq1}\\
Y &= i_2 + c'X + bM + e_2 \label{eq2}\\
M &= i_3 + aX + e_3 \label{eq3}
\end{align}

\begin{itemize}
\item Equation \ref{eq1} gives us the total effect ($c$).
  \vb
\item Equation \ref{eq2} gives us the direct effect ($c'$) and the
  partialled effect of the mediator on the outcome ($b$).
  \vb
\item Equation \ref{eq3} gives us the effect of the input on the
  outcome ($a$).
\end{itemize}

\end{frame}



\begin{frame}[shrink = 5]{Two Measures of Indirect Effect}

  Recall the two definitions of an indirect effect:
  \begin{align}
    IE_{diff} &= c - c'\\
    IE_{prod} &= a \cdot b
  \end{align}

  It pays to remember a few key points:
  \vc
  \begin{itemize}
  \item $IE_{diff}$ and $IE_{prod}$ are equivalent in simple
    mediation.
    \vb
  \item $IE_{diff}$ is only an indirect indication of the parameter
    we're truly interested in $IE_{prod}$.
    \vb
  \item A significant indirect effect can exist without a significant
    total effect.
    \vb
  \item If we hypothesize a significant indirect effect, then we don't
    care about the total effect.
  \end{itemize}
  \vb
  These points imply something interesting:
  \vc
  \begin{itemize}
    \item We don't need to estimate $c$!
  \end{itemize}

\end{frame}



\begin{frame}{Simplifying our Path Diagram}

  \textsc{Question:} If we don't care about estimating $c$, how can we
  simplify this diagram?

  \begin{figure}
    \includegraphics[width=\textwidth]{figures/simpleMediationPathDiagram.pdf}
  \end{figure}

\end{frame}



\begin{frame}{Simplifying our Path Diagram}

  \textsc{Answer:} We don't fit the upper model.
  
  \vspace{-12pt}
  
  \begin{figure}
    \includegraphics[width=\textwidth]{figures/mediationTriadPathDiagram.pdf}
  \end{figure}
  
  \vspace{-24pt}
  
  \textsc{Follow-Up Question:} Do we really need to bother?

\end{frame}



\begin{frame}{Why Path Analysis?}

  \begin{figure}
    \includegraphics[width=\textwidth]{figures/multipleMediationPathDiagrams.pdf}
  \end{figure}

\end{frame}



\begin{frame}{Example}

  Let's revisit the example from last week:

  \vspace{-12pt}
  
  \begin{figure}
    \includegraphics[width=\textwidth]{figures/adamsKlpsExample1PathDiagram.pdf}
  \end{figure}

  \vspace{-24pt}
  
  We already fit this model with the OLS approach.

\end{frame}



\begin{frame}[allowframebreaks]{Example}

<<>>=
dat1 <- readRDS("../data/adamsKlpsScaleScore.rds")

## Partial out the mediator's effect:
mod1 <- lm(policy ~ sysRac + polAffil, data = dat1)
mod2 <- lm(sysRac ~ polAffil, data = dat1)

summary(mod1)$coef
summary(mod2)$coef

## Extract important parameter estimates:
a <- coef(mod2)["polAffil"]
b <- coef(mod1)["sysRac"]

## Compute indirect effect:
ieProd <- a * b
ieProd

## Calculate Sobel's Z:
seA <- sqrt(diag(vcov(mod2)))["polAffil"]
seB <- sqrt(diag(vcov(mod1)))["sysRac"]

sobelSE <- sqrt(b^2 * seA^2 + a^2 * seB^2)

sobelZ <- ieProd / sobelSE
sobelZ

sobelP <- 2 * pnorm(sobelZ, lower = FALSE)
sobelP

sobelUB <- ieProd + 1.96 * sobelSE
sobelLB <- ieProd - 1.96 * sobelSE

## 95% Sobel CI:
c(sobelLB, sobelUB)
@

\end{frame}



\begin{frame}[allowframebreaks]{Example}

<<>>=
## Load the lavaan package:
library(lavaan)

## Specify the basic path model:
mod1 <- "
policy ~ sysRac + polAffil
sysRac ~ polAffil
"

## Estimate the model:
out1 <- cfa(mod1, data = dat1)

## Look at the results:
summary(out1)

## Include the indirect effect:
mod2 <- "
policy ~ b*sysRac + polAffil
sysRac ~ a*polAffil

ab := a*b # Define a parameter for the indirect effect
"

## Estimate the model:
out2 <- cfa(mod2, data = dat1)

## Look at the results:
summary(out2)
@ 

\end{frame}



\begin{frame}[shrink = 15]{Example}
  
<<>>=
## We can also get CIs:
parameterEstimates(out2)
@

\end{frame}



\begin{frame}{Results}
  
  \begin{figure}
    \begin{center}
      \includegraphics[width = \textwidth]{figures/adamsKlpsExample1PathDiagramWithValues.pdf}
    \end{center}
  \end{figure}
  
\end{frame}



\begin{frame}{We're not there yet...}
  
  Path analysis allows us to model complex (and simple) patterns of
  association very parsimoniously, but the preceding example still
  suffers from a considerable limitation.
  \pause
  \va
  \begin{itemize}
  \item The significance test for the indirect effect is still
    conducted with the Sobel Z approach.
  \end{itemize}
  \va
  Path analysis (or full SEM) doesn't magically get around
  distributional problems associated with Sobel's Z test.\\ 
  \va 
  To get a robust significance test of the indirect effect, 
  we need to use \emph{bootstrapping}.
  
\end{frame}



\begin{frame}[shrink = 5]{Bootstrapping}
  
  Bootstrapping was introduced by \citet{efron:1979} as a tool for
  non-parametric inference.
  \vb
  \begin{itemize}
    \item Traditional inference requires that we assume a parametric
      sampling distribution for our focal parameter.
      \vb
    \item We need to make such an assumption to compute the standard
      errors we require for inferences.
      \vb
    \item If we cannot safely make these assumptions, we can use
      bootstrapping.
  \end{itemize}
  \va
  Assume our observed data $Data_0$ represent the population and:
  \vb
  \begin{enumerate}
    \item Sample rows of $Data_0$, with replacement, to create $B$ new
      samples $\{Data_b\}$.
      \vb
    \item Calculate our focal statistic on each of the $B$ bootstrap
      samples. \label{calcStatsStep}
      \vb
    \item Make inferences based on the empirical distribution of the
      $B$ estimates calculated in Step \ref{calcStatsStep}
  \end{enumerate}
  
\end{frame}



\begin{frame}{Bootstrapping}
  
  \begin{figure}
    \begin{center}
      \includegraphics[width=\textwidth]{figures/bootstrappingDiagram.pdf}
    \end{center}
  \end{figure}
  
\end{frame}



\begin{frame}{Bootstrapping}
  
  It's important to recognize that the following are legal bootstrap samples:
  
  \vspace{-12pt}
  
  \begin{figure}
    \begin{center}
      \includegraphics[width=\textwidth]{figures/perverseBootstrappingDiagram.pdf}
    \end{center}
  \end{figure}
  
\end{frame}



\begin{frame}[shrink = 5]{Example}
  
  Suppose I'm on the lookout for a retirement location. Since I want
  to relax in my old-age, I'm concerned with ensuring a low
  probability of dragon attacks, so I have a few salient
  considerations: \vb
  \begin{itemize}
    \item Shooting for a location with no dragons, whatsoever, is a
      fools errand (since dragons are, obviously, ubiquitous).
      \vb
    \item I merely require a location that has at least two times as many
      dragon-free days as other kinds.
  \end{itemize}
  \va
  I've been watching several candidate locales over the course of my
  (long and illustrious) career, and I'm particularly hopeful about
  one quiet hamlet in the Patagonian highlands.
  \vb
  \begin{itemize}
  \item To ensure that my required degree of dragon-freeness is met,
    I'll use the \emph{Dragon Risk Index} (DRI):
    \begin{align*}
      DRI = \textit{Median}\left( \frac{\text{Dragon-Free Days}}{\text{Dragonned Days}} \right)
    \end{align*}
  \end{itemize}
  
\end{frame}



\begin{frame}[allowframebreaks]{Example}
  
<<>>=
## Read in the observed data:
rawData <- readRDS("../data/daysData.rds")

## Compute the observed test statistic:
obsDRI <- median(rawData$goodDays / rawData$badDays)
obsDRI

## Draw the bootstrap samples:
set.seed(235711)
nSams <- 5000
bootDRI <- rep(NA, nSams)
for(b in 1 : nSams) {
    bootSam <- rawData[sample(c(1 : nrow(rawData)),
                              replace = TRUE), ]
    bootDRI[b] <- 
        median(bootSam$goodDays / bootSam$badDays)
}
@

\pagebreak

<<echo=F, fig=T>>=
par(family = "serif")

## Summarize the empirical sampling distribution:
hist(bootDRI,
     xlab = "Dragon Risk Index",
     main = "Empirical Sampling Distribution of DRI",
     freq = FALSE)
lines(density(bootDRI, adjust = 3), 
      col = "red")
legend("topright",
       inset = 0.02,
       legend = "Smoothed Density",
       col = "red",
       lty = 1)
@ 

\pagebreak
To see if I can be confident in the dragon-freeness of my potential
home, I'll summarize the preceding distribution with a (one-tailed)
percentile confidence interval: 
\va
<<>>= 
bootLB <- sort(bootDRI)[0.05 * nSams]
bootUB <- Inf

## The bootstrapped Percentile CI:
c(bootLB, bootUB)
@ 

\end{frame}


\begin{frame}[shrink = 5]{Bootstrapped Path Modeling}
  
  We can apply the same procedure I just demonstrated to testing the
  indirect effect's significance with path modeling.
  \vb
  \begin{itemize}
  \item The problem with Sobel's Z is exactly the type of issue for which
    bootstrapping was designed
    \vc
    \begin{itemize}
    \item We don't know a reasonable finite-sample sampling
      distribution for the $ab$ parameter.
    \end{itemize}
    \vb  
  \item Bootstrapping will allow us to construct an empirical
    sampling distribution for $ab$ and use that empirical
    distribution to construct confidence intervals for inference.
  \end{itemize}
  \va
  All we need to do is:
  \vc
  \begin{enumerate}
  \item Resample our observed data with replacement
    \vc
  \item Fit our hypothesized path model to each bootstrap sample
    \vc
  \item Store the value of $ab$ that we get each time
    \vc
  \item Summarize the empirical distribution of $ab$ to make inferences
  \end{enumerate}
  
\end{frame}


\begin{frame}[allowframebreaks]{Example}
  
<<>>=
nSams <- 1000
abVec <- rep(NA, nSams)
for(i in 1 : nSams) {
    ## Resample the data:
    bootSam <- 
        dat1[sample(c(1 : nrow(dat1)), replace = TRUE), ]
    ## Fit the path model:
    bootOut <- sem(mod2, data = bootSam)
    ## Store the estimated indirect effect:
    abVec[i] <- prod(coef(bootOut)[c("a", "b")])
}
@ 

\pagebreak

<<echo=F, fig=T>>=
par(family = "serif")

## Plot the empirical sampling distribution of a*b:
hist(abVec,
     freq = FALSE,
     main = "Empirical Sampling Distribution of a*b",
     xlab = "a*b")
lines(density(abVec), col = "red")
@

\pagebreak

<<>>=
## Calculate the percentile CI:
lb <- sort(abVec)[0.025 * nSams]
ub <- sort(abVec)[0.975 * nSams]
c(lb, ub)
@ 

\end{frame}


\begin{frame}[shrink = 15]{Example}
  
<<>>=
## OR, much more parsimoniously:
bootOut2 <- sem(mod2, data = dat1, se = "boot", bootstrap = 1000)

parameterEstimates(bootOut2)
parameterEstimates(bootOut2, boot.ci.type = "bca.simple")
@

\end{frame}
  

\begin{frame}[shrink = 5]{Monte Carlo Method/Parametric Bootstrap}
  
  We can also use a \emph{parametric bootstrap} of the individual
  parameters $a$ and $b$ to get a somewhat robust test of the indirect
  effect.  
  \vb
  \begin{itemize}
  \item Assuming normal sampling distributions for $a$ and $b$ is
    not, generally, problematic
    \vb
  \item We can save ourselves a lot of computational effort by
    assuming normality for $a$ and $b$, then:
    \vb
    \begin{enumerate}
    \item Fit the hypothesized path model to the raw data
      \vb
    \item Extract $a$, $b$, and $\textit{ACOV}(\{a, b\})$ from the fitted
      path model 
      \vb
    \item Parameterize a bivariate normal distribution $\text{N}(a, b
      |\mu, \Sigma)$ with $\mu = \{a, b\}$ and $\Sigma =
      \textit{ACOV}(\{a, b\})$ 
      \vb
    \item Draw simulated values $\{\tilde{a}, \tilde{b}\}$ from
      $\text{N}(a, b | \mu, \Sigma)$ 
      \vb
    \item Compute the simulated indirect effect
      $\widetilde{ab} = \tilde{a} \cdot \tilde{b}$ and store it
      \vb
    \item Summarize the empirical distribution of $\widetilde{ab}$
      for inference.
    \end{enumerate}
  \end{itemize}
  
\end{frame}



\begin{frame}[allowframebreaks]{Example}
  
<<>>=
## Load package to draw the Monte Carlo samples
library(mvtnorm) 

## Specify the model (note the parameter labels):
mod3 <- "
policy ~ polAffil + b*sysRac
sysRac ~ a*polAffil
"

## Fit the model:
out4 <- sem(mod3, data = dat1)

## Extract the important estimates:
a <- coef(out4)["a"]
b <- coef(out4)["b"]
acov <- vcov(out4)[c("a", "b"), c("a", "b")]
@ 

\end{frame}


\begin{frame}[allowframebreaks]{Aside Regarding Asymptotic Covariances}

  The \emph{asymptotic covariance matrix} (ACOV) is (-1 times) the
  inverse of the Fisher information matrix of the model parameters.
  \vb  
  \begin{itemize}
  \item The $ACOV$ contains the expected covariance among the ML
    estimates of the model parameters.
    \vb
  \item The diagonal elements of the matrix (i.e., the asymptotic
    variances) are the square of the usual ML SE estimates.
  \end{itemize}
  \va
<<>>=
round(vcov(out4), 4)
@ 

\end{frame}


\begin{frame}[allowframebreaks]{Back to the Example}
  
<<>>=
## Look at ACOV(a,b):
round(acov, 4)

## Draw the Monte Carlo samples:
samMat <- rmvnorm(nSams, c(a, b), acov)
abVec <- samMat[ , "a"] * samMat[ , "b"]
@ 

\pagebreak

<<echo=F, fig=T>>=
par(family = "serif")

## Plot the empirical sampling distribution of a*b:
hist(abVec,
     freq = FALSE,
     main = "Monte Carlo Distribution of a*b",
     xlab = "a*b")
lines(density(abVec), col = "red")
@

\pagebreak

<<>>=
## Calculate the percentile CI:
lb <- sort(abVec)[0.025 * nSams]
ub <- sort(abVec)[0.975 * nSams]
c(lb, ub)
@ 

\end{frame}


\begin{frame}{Kris Preacher's Website}
  
  If you don't want to program the Monte Carlo approach yourself
  (although each of you easily can), you should consider the very
  handy Web App on Professor Kris Preacher's website
  \url{http://www.quantpsy.org}.  
  \va
  \begin{itemize}
    \item Kris' website has a vast array of hugely helpful resources
      for anyone doing mediation or moderation analysis.
      \vb 
    \item You should definitely check it out!
  \end{itemize}
  
\end{frame}



\begin{frame}{\textsc{References}}
\bibliographystyle{apacite}
\bibliography{../../bibtexStuff/dissRefsList}
\end{frame}


\end{document}
