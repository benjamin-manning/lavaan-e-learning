\begin{Schunk}
\begin{Sinput}
 predDat <- as.matrix(dat1[ , -grep("y", colnames(dat1))])
 dat2 <- dat1
 ## Construct product terms:
 x1z1 <- with(dat2, x1*z1)
 x1z2 <- with(dat2, x1*z2)
 x1z3 <- with(dat2, x1*z3)
 x2z1 <- with(dat2, x2*z1)
 x2z2 <- with(dat2, x2*z2)
 x2z3 <- with(dat2, x2*z3)
 x3z1 <- with(dat2, x3*z1)
 x3z2 <- with(dat2, x3*z2)
 x3z3 <- with(dat2, x3*z3)
 ## Residualize the product terms:
 dat2$x1z1R <- lm(x1z1 ~ predDat)$resid
 dat2$x1z2R <- lm(x1z2 ~ predDat)$resid
 dat2$x1z3R <- lm(x1z3 ~ predDat)$resid
 dat2$x2z1R <- lm(x2z1 ~ predDat)$resid
 dat2$x2z2R <- lm(x2z2 ~ predDat)$resid
 dat2$x2z3R <- lm(x2z3 ~ predDat)$resid
 dat2$x3z1R <- lm(x3z1 ~ predDat)$resid
 dat2$x3z2R <- lm(x3z2 ~ predDat)$resid
 dat2$x3z3R <- lm(x3z3 ~ predDat)$resid
\end{Sinput}
\end{Schunk}
